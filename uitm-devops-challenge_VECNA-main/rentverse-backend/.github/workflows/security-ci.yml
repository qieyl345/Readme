name: ğŸ›¡ï¸ Security CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run security scans daily at 2 AM UTC
    - cron: '0 2 * * *'

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'

jobs:
  # Job 1: Code Quality and SAST Security Analysis
  security-analysis:
    name: ğŸ” SAST Security Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: ğŸ”§ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ Install dependencies
        run: |
          npm ci
          pip install safety bandit semgrep

      - name: ğŸ›¡ï¸ Run ESLint Security Rules
        run: |
          npx eslint . --ext .js,.ts,.jsx,.tsx --format json --output-file eslint-security-report.json || true

      - name: ğŸ” Run Semgrep SAST Scan
        run: |
          semgrep --config=auto --json --output=semgrep-report.json --severity=ERROR --severity=WARNING . || true
          semgrep --config=auto --text --output=semgrep-report.txt --severity=ERROR --severity=WARNING . || true

      - name: ğŸ Run Bandit Python Security Scan
        run: |
          bandit -r . -f json -o bandit-report.json || true
          bandit -r . -f txt -o bandit-report.txt || true

      - name: ğŸ”’ Run Safety Dependency Vulnerability Scan
        run: |
          safety check --json --output safety-report.json || true
          safety check --output safety-report.txt || true

      - name: ğŸ“Š Generate Security Summary
        run: |
          node .github/scripts/generate-security-summary.js

      - name: ğŸ“¤ Upload Security Reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: security-analysis-reports
          path: |
            *-security-report.json
            *-security-report.txt
            semgrep-report.json
            semgrep-report.txt
            bandit-report.json
            bandit-report.txt
            safety-report.json
            safety-report.txt
            security-summary.md

      - name: ğŸ’¬ Comment Security Results on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            try {
              const summary = fs.readFileSync('security-summary.md', 'utf8');
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: summary
              });
            } catch (error) {
              console.log('Could not read security summary:', error.message);
            }

  # Job 2: Secret Detection
  secret-detection:
    name: ğŸ” Secret Detection
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” TruffleHog Secret Scanner
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified

      - name: ğŸ” GitLeaks Secret Scanner
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

  # Job 3: Container Security Scan
  container-security:
    name: ğŸ³ Container Security Scan
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, '[docker]') || github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: ğŸ—ï¸ Build Docker image
        run: |
          docker build -t rentverse-backend:${{ github.sha }} .

      - name: ğŸ” Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'rentverse-backend:${{ github.sha }}'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: ğŸ“¤ Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: ğŸ“Š Run Anchore Grype scanner
        uses: anchore/scan-action@v3
        with:
          image: 'rentverse-backend:${{ github.sha }}'
          format: json
          output-file: grype-report.json

      - name: ğŸ“¤ Upload Grype report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: container-security-reports
          path: grype-report.json

  # Job 4: License Compliance
  license-compliance:
    name: ğŸ“œ License Compliance
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ“Š License Checker
        run: |
          npx license-checker --json --out licenses.json
          npx license-checker --summary

      - name: ğŸš« Blacklist risky licenses
        run: |
          node .github/scripts/check-licenses.js

      - name: ğŸ“¤ Upload license report
        uses: actions/upload-artifact@v3
        with:
          name: license-reports
          path: licenses.json

  # Job 5: Infrastructure Security Scan
  infrastructure-security:
    name: ğŸ—ï¸ Infrastructure Security
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, '[infra]') || github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Checkov Infrastructure Scan
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
          framework: dockerfile,secrets,secrets_aws,github_actions

      - name: ğŸ” KICS Infrastructure Scan
        uses: checkmarx/kics-action@v2
        with:
          path: '.'
          platform_type: 'docker'
          output_path: 'kics-results.json'
          output_formats: 'json,html'

      - name: ğŸ“¤ Upload KICS results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: infrastructure-security-reports
          path: kics-results.json

  # Job 6: Database Security Analysis
  database-security:
    name: ğŸ—„ï¸ Database Security
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” SQL Injection Pattern Detection
        run: |
          node .github/scripts/detect-sql-injection.js

      - name: ğŸ” Prisma Schema Security Check
        run: |
          node .github/scripts/check-prisma-security.js

      - name: ğŸ“¤ Upload database security reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: database-security-reports
          path: database-security-*.json

  # Job 7: Security Gate (Fail the build if critical issues found)
  security-gate:
    name: ğŸš¦ Security Gate
    runs-on: ubuntu-latest
    needs: [security-analysis, secret-detection, container-security, license-compliance]
    if: always()
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“Š Download all security reports
        uses: actions/download-artifact@v3
        with:
          path: security-reports/

      - name: ğŸš¦ Evaluate Security Gate
        run: |
          node .github/scripts/security-gate.js

      - name: ğŸ“ Create security report
        run: |
          node .github/scripts/generate-final-security-report.js

      - name: ğŸ“¤ Upload final security report
        uses: actions/upload-artifact@v3
        with:
          name: final-security-report
          path: final-security-report.md

      - name: ğŸš¨ Fail on Critical Security Issues
        if: failure()
        run: |
          echo "âŒ Security gate failed! Critical security issues detected."
          echo "ğŸ“‹ Please review the security reports and fix identified issues."
          exit 1

  # Job 8: Security Documentation Update
  security-docs:
    name: ğŸ“š Update Security Documentation
    runs-on: ubuntu-latest
    needs: [security-gate]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“Š Download security reports
        uses: actions/download-artifact@v3
        with:
          name: final-security-report
          path: docs/

      - name: ğŸ“š Update Security Documentation
        run: |
          node .github/scripts/update-security-docs.js

      - name: ğŸ“¤ Commit security documentation
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: 'ğŸ“š Update security documentation'
          file_pattern: docs/security-*.md